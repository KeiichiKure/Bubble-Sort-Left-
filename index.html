<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>バブルソートシミュレーション（左端確定版）</title>
<style>
  body {
    font-family: system-ui, sans-serif;
    padding: 20px;
    background: #f5f5f5;
  }
  h1 { font-size: 1.8rem; text-align: center; }

  .controls {
    margin-bottom: 1rem;
    text-align: center;
  }
  .controls input { width: 260px; padding: 6px; font-size: 1.1rem; }
  .controls button { padding: 6px 14px; margin-left: 6px; font-size: 1.1rem; }
  .controls select { padding: 6px; font-size: 1.1rem; margin-left: 10px; }

  #mainArea {
    display: flex;
    justify-content: center;
    gap: 40px;
    margin-top: 20px;
  }

  #leftColumn {
    width: 260px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .panel {
    background: #fff;
    border-radius: 10px;
    border: 1px solid #ccc;
    padding: 12px;
    font-size: 1.1rem;
    min-height: 120px;
  }
  .panel h3 { margin: 0 0 6px; font-size: 1.3rem; }

  #centerColumn {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  #chart {
    display: flex;
    justify-content: center;
    align-items: flex-end;
    gap: 25px;
    height: 350px;
    margin: 30px 0 10px 0;
    position: relative;
  }

  .bar-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .bar {
    width: 80px;
    background: #4fc3f7;
    border-radius: 8px 8px 0 0;
    text-align: center;
    color: #000;
    font-weight: bold;
    font-size: 1.4rem;
    transition: height 0.4s ease, background 0.3s;
    position: relative;
  }

  .index-label {
    margin-top: 6px;
    font-size: 1.2rem;
    color: #333;
  }

  .compare { background: #ffb74d !important; }
  .sorted { background: #81c784 !important; }

  .ghost {
    position: fixed;
    width: 80px;
    background: #f06292;
    border-radius: 8px 8px 0 0;
    text-align: center;
    color: #000;
    font-weight: bold;
    font-size: 1.4rem;
    pointer-events: none;
    transition: transform 0.6s ease;
    z-index: 1000;
  }

  #tempArea {
    margin-top: 10px;
    text-align: center;
  }
  #tempBox {
    width: 140px;
    height: 140px;
    border: 4px dashed #333;
    background: #fff;
    border-radius: 10px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.6rem;
    font-weight: bold;
    margin: 0 auto;
  }

  #rightColumn {
    width: 260px;
  }

  #log {
    background: white;
    padding: 12px;
    border: 1px solid #ccc;
    height: 350px;
    overflow-y: auto;
    white-space: pre-wrap;
    font-size: 1rem;
    border-radius: 10px;
  }
</style>
</head>
<body>

<h1>バブルソートシミュレーション（左端確定版）</h1>

<div class="controls">
  <input id="inputArray" type="text" value="5,3,8,4,2">
  <button id="prepareBtn">準備</button>
  <button id="nextBtn" disabled>次のステップ</button>
  <button id="resetBtn">リセット</button>

  <select id="orderSelect">
    <option value="asc">昇順（小さい値が左端に確定）</option>
    <option value="desc">降順（大きい値が左端に確定）</option>
  </select>
</div>

<div id="mainArea">

  <div id="leftColumn">
    <div class="panel">
      <h3>これからやること</h3>
      <div id="nextAction">「準備」を押してください。</div>
    </div>

    <div class="panel">
      <h3>今やったこと</h3>
      <div id="currentAction">まだ何もしていません。</div>
    </div>
  </div>

  <div id="centerColumn">
    <div id="chart"></div>

    <div id="tempArea">
      <h3>temp（仮置きの箱）</h3>
      <div id="tempBox">空</div>
    </div>
  </div>

  <div id="rightColumn">
    <h3>ログ</h3>
    <div id="log"></div>
  </div>

</div>

<script>
  const inputEl = document.getElementById("inputArray");
  const prepareBtn = document.getElementById("prepareBtn");
  const nextBtn = document.getElementById("nextBtn");
  const resetBtn = document.getElementById("resetBtn");
  const orderSelect = document.getElementById("orderSelect");

  const chartEl = document.getElementById("chart");
  const tempBox = document.getElementById("tempBox");
  const nextActionEl = document.getElementById("nextAction");
  const currentActionEl = document.getElementById("currentAction");
  const logEl = document.getElementById("log");

  let arr = [];
  let bars = [];
  let wrappers = [];
  let i = 0, j = 0;
  let n = 0;
  let sortedBoundary = 0; // 左端から確定
  let finished = false;

  let phase = "idle";
  let needSwap = false;
  let tempValue = null;

  let tempGhost = null;
  let rightGhost = null;

  function log(msg) {
    logEl.textContent += msg + "\n";
    logEl.scrollTop = logEl.scrollHeight;
  }

  function renderBars() {
    chartEl.innerHTML = "";
    bars = [];
    wrappers = [];

    arr.forEach((v, idx) => {
      const wrapper = document.createElement("div");
      wrapper.className = "bar-wrapper";

      const bar = document.createElement("div");
      bar.className = "bar";
      bar.style.height = (v * 40) + "px";
      bar.textContent = v;

      if (idx < sortedBoundary) bar.classList.add("sorted");

      const label = document.createElement("div");
      label.className = "index-label";
      label.textContent = idx;

      wrapper.appendChild(bar);
      wrapper.appendChild(label);

      chartEl.appendChild(wrapper);

      bars.push(bar);
      wrappers.push(wrapper);
    });
  }

  function highlight(i1, i2) {
    bars.forEach(b => b.classList.remove("compare"));
    bars[i1].classList.add("compare");
    bars[i2].classList.add("compare");
  }

  function clearHighlight() {
    bars.forEach(b => b.classList.remove("compare"));
  }

  function createGhost(fromBar, value) {
    const rect = fromBar.getBoundingClientRect();
    const ghost = document.createElement("div");
    ghost.className = "ghost";
    ghost.style.height = rect.height + "px";
    ghost.textContent = value;
    ghost.style.left = rect.left + "px";
    ghost.style.top = rect.top + "px";
    document.body.appendChild(ghost);
    return ghost;
  }

  function moveGhostToRect(ghost, targetRect) {
    const g = ghost.getBoundingClientRect();

    const ghostCenterX = g.left + g.width / 2;
    const ghostCenterY = g.top + g.height / 2;

    const targetCenterX = targetRect.left + targetRect.width / 2;
    const targetCenterY = targetRect.top + targetRect.height / 2;

    const dx = targetCenterX - ghostCenterX;
    const dy = targetCenterY - ghostCenterY;

    ghost.style.transform = `translate(${dx}px, ${dy}px)`;
  }

  function reset() {
    arr = [];
    bars = [];
    wrappers = [];
    i = j = 0;
    sortedBoundary = 0;
    finished = false;
    phase = "idle";
    needSwap = false;
    tempValue = null;

    if (tempGhost) tempGhost.remove();
    if (rightGhost) rightGhost.remove();
    tempGhost = null;
    rightGhost = null;

    chartEl.innerHTML = "";
    tempBox.textContent = "空";
    nextActionEl.textContent = "「準備」を押してください。";
    currentActionEl.textContent = "まだ何もしていません。";
    logEl.textContent = "";
    nextBtn.disabled = true;
  }

  function prepare() {
    reset();
    const nums = inputEl.value.split(",").map(s => Number(s.trim()));
    if (nums.some(isNaN)) {
      alert("数値をカンマ区切りで入力してください");
      return;
    }
    arr = nums;
    n = arr.length;
    renderBars();
    log("準備完了: [" + arr.join(", ") + "]");
    i = 0;
    sortedBoundary = 0;
    j = n - 1; // 右から左へ走査
    phase = "compare";
    nextActionEl.textContent = `次：棒 ${j-1} と ${j} を比較します。`;
    nextBtn.disabled = false;
  }

  function nextStep() {
    if (finished) return;

    const leftIndex = j - 1;
    const rightIndex = j;

    if (leftIndex < 0 || rightIndex <= leftIndex) {
      phase = "advance";
    }

    const order = orderSelect.value;

    if (phase === "compare") {
      const a = arr[leftIndex];
      const b = arr[rightIndex];

      needSwap = (order === "asc") ? (a > b) : (a < b);

      highlight(leftIndex, rightIndex);
      currentActionEl.textContent = `比較：${a} と ${b}`;
      log(`比較: ${a} と ${b}`);

      if (needSwap) {
        nextActionEl.textContent = "次：temp = 左の値（左の棒を temp に移動）";
        phase = "toTemp";
      } else {
        nextActionEl.textContent = "次：入れ替えはしません。次のペアへ。";
        phase = "noSwap";
      }
      return;
    }

    if (phase === "toTemp") {
      const a = arr[leftIndex];
      tempValue = a;
      tempBox.textContent = tempValue;

      tempGhost = createGhost(bars[leftIndex], a);
      moveGhostToRect(tempGhost, tempBox.getBoundingClientRect());

      currentActionEl.textContent = `temp = ${a} として退避しました。`;
      log(`temp = ${a}`);

      phase = "copyRightToLeft";
      nextActionEl.textContent = "次：右の値を左にコピーします。";
      return;
    }

    if (phase === "copyRightToLeft") {
      const b = arr[rightIndex];

      rightGhost = createGhost(bars[rightIndex], b);
      moveGhostToRect(rightGhost, wrappers[leftIndex].getBoundingClientRect());

      setTimeout(() => {
        arr[leftIndex] = b;
        bars[leftIndex].style.height = (b * 40) + "px";
        bars[leftIndex].textContent = b;
        rightGhost.remove();
        rightGhost = null;
      }, 600);

      currentActionEl.textContent = `a[${leftIndex}] = a[${rightIndex}] として左にコピーしました。`;
      log(`左に ${b} をコピー`);

      phase = "tempToRight";
      nextActionEl.textContent = "次：temp の値を右にコピーします。";
      return;
    }

    if (phase === "tempToRight") {
      moveGhostToRect(tempGhost, wrappers[rightIndex].getBoundingClientRect());

      setTimeout(() => {
        arr[rightIndex] = tempValue;
        bars[rightIndex].style.height = (tempValue * 40) + "px";
        bars[rightIndex].textContent = tempValue;

        tempGhost.remove();
        tempGhost = null;
      }, 600);

      currentActionEl.textContent = `a[${rightIndex}] = temp として右にコピーしました。`;
      log(`右に temp をコピー → [${arr.join(", ")}]`);

      phase = "advance";
      nextActionEl.textContent = "次：次のペアへ進みます。";
      return;
    }

    if (phase === "noSwap") {
      currentActionEl.textContent = "入れ替えは不要でした。";
      log("入れ替えなし");
      phase = "advance";
      nextActionEl.textContent = "次：次のペアへ進みます。";
      return;
    }

    if (phase === "advance") {
      clearHighlight();
      j--; // 右から左へ進む

      // ★ 修正ポイント：j が i+1 未満になったらパス終了
      if (j < i + 1) {
        sortedBoundary = i + 1; // 左端から i まで確定
        log(`--- パス ${i+1} 終了（左端 ${sortedBoundary-1} まで確定） ---`);
        i++;
        if (i >= n - 1) {
          finished = true;
          sortedBoundary = n;
          renderBars();
          currentActionEl.textContent = "ソート完了！";
          nextActionEl.textContent = "完了しました。";
          log("ソート完了（左端確定バブルソート）");
          return;
        }
        renderBars();
        j = n - 1; // 次のパスはまた右端から
      }

      phase = "compare";
      const nextLeft = j - 1;
      const nextRight = j;
      nextActionEl.textContent = `次：棒 ${nextLeft} と ${nextRight} を比較します。`;
      currentActionEl.textContent = "次のペアに進みました。";
      return;
    }
  }

  prepareBtn.addEventListener("click", prepare);
  nextBtn.addEventListener("click", nextStep);
  resetBtn.addEventListener("click", reset);
</script>

</body>
</html>

